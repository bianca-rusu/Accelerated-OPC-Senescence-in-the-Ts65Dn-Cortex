# Load the object and required packages.
library(Seurat)
library(Signac)
library(BSgenome.Mmusculus.UCSC.mm10)
library(EnsDb.Mmusculus.v79)
ATAC <- readRDS("Ts65Dn_OPC_Senescence_ATAC_Object.rds")
Idents(atacAggr) <- "group_manual_labels"
DefaultAssay(atacAggr) <- 'peaks'

# Perform differential accessibility analysis (same analysis to be performed on Inhibitory and Excitatory neurons).
GetMarkers <- function(cluster, seurat_aggregate) {
  print(paste0("Finding DAR for: ",cluster,"-DS VS CTL"))
  cluster1 <- paste0('DS_',cluster)
  cluster2 <- paste0('Control_',cluster)
  atacAggr <- seurat_aggregate
  dar <- FindMarkers(atacAggr, ident.1 = cluster1, ident.2 = cluster2, test.use = 'LR', latent.vars = "nCount_peaks",
                     logfc.threshold=0.1)
  cf <- ClosestFeature(atacAggr,rownames(dar))
  dar$FDR<-p.adjust(dar$p_val, method="BH")
  dar$sig<-dar$FDR<0.05
  return(cbind(dar, gene=cf$gene_name, distance=cf$distance))
}
idents <- levels(atacAggr@meta.data$celltype)
list.cluster.dar <- lapply(idents, function(x) {GetMarkers(x, seurat_aggregate = atacAggr)})
dir.create(here("DAR_DS_VS_CTL"), showWarnings = FALSE)
